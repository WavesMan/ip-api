name: Build DB & Frontend and Publish Pages

on:
  schedule:
    - cron: "0 2 * * 1"
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Install
        run: pnpm install --frozen-lockfile=false
      - name: Build data
        run: pnpm run build:db
      - name: Build frontend
        run: pnpm run build
      - name: Prepare deploy content
        run: |
          rm -rf deploy && mkdir -p deploy
          cp -r dist/* deploy/
          mkdir -p deploy/edge-functions/chunks
          cp edge-functions/dict.js deploy/edge-functions/ || true
          cp -r edge-functions/chunks deploy/edge-functions/ || true
          cp edgeone.config.js deploy/ || true
          if [ -d public ]; then cp -r public/* deploy/; fi
      - name: Publish to pages branch
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git fetch origin
          git checkout -B pages
          git rm -r --cached . || true
          find . -mindepth 1 -maxdepth 1 ! -name .git -exec rm -rf {} +
          cp -r deploy/* .
          git add .
          git commit -m "deploy: update pages content" || echo "No changes to commit"
          git push -f origin pages
